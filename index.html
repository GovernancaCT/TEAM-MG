<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quiz da Reuni√£o</title>

<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f4f4f9;
    text-align: center;
  }
  .hidden { display: none; }
  .screen { padding: 40px; }

  input {
    padding: 10px;
    width: 250px;
    border-radius: 6px;
    border: 1px solid #aaa;
    font-size: 16px;
  }

  button {
    padding: 12px 20px;
    background: #FF5722;
    border: none;
    border-radius: 8px;
    font-size: 18px;
    color: #fff;
    cursor: pointer;
    margin-top: 20px;
  }
  button:hover { opacity: 0.9; }

  .opcao {
    padding: 12px;
    margin: 10px auto;
    background: #fff;
    border: 2px solid #FF5722;
    width: 80%;
    border-radius: 8px;
    cursor: pointer;
  }

  table {
    margin: 20px auto;
    width: 90%;
    border-collapse: collapse;
  }
  th, td {
    padding: 10px;
    border: 1px solid #ccc;
  }
  th {
    background: #FF5722;
    color: white;
  }
  .timer {
    margin-top: 20px;
    font-weight: bold;
    font-size: 20px;
  }

  /* ====== P√ìDIO ANIMADO ====== */
  #podioContainer {
    margin-top: 30px;
    display: flex;
    justify-content: center;
    align-items: flex-end;
    gap: 20px;
  }
  .podium {
    width: 120px;
    border-radius: 12px 12px 0 0;
    background: #FF9800;
    color: #fff;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    align-items: center;
    padding: 10px 5px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    opacity: 0;
    transform: translateY(40px);
    animation: subir 0.8s ease-out forwards;
  }
  .podium-1 { height: 220px; animation-delay: 0.2s; background: #FFC107; }
  .podium-2 { height: 170px; animation-delay: 0s;   background: #FF9800; }
  .podium-3 { height: 150px; animation-delay: 0.4s; background: #FFB74D; }

  .podium-pos {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 8px;
  }
  .podium-name {
    font-weight: bold;
    font-size: 14px;
    margin-bottom: 6px;
    text-wrap: balance;
  }
  .podium-points {
    font-size: 12px;
    opacity: 0.9;
  }

  @keyframes subir {
    from { opacity: 0; transform: translateY(40px); }
    to   { opacity: 1; transform: translateY(0); }
  }

</style>

</head>
<body>

<!-- === QR CODE === -->
<div id="qrScreen" class="screen">
  <h1>üîí Acesso Restrito</h1>
  <p>Escaneie o QR Code para participar</p>
  <img src="SEU_QRCODE.png" width="200">
  <button onclick="acessarComQR()">J√° escaneei</button>
</div>

<!-- === CADASTRO === -->
<div id="cadastroScreen" class="screen hidden">
  <h2>Digite seu nome para entrar</h2>
  <input id="nomeJogador" placeholder="Seu nome">
  <button onclick="entrar()">Entrar</button>
</div>

<!-- === SALA COM CONTAGEM === -->
<div id="posCadastroScreen" class="screen hidden">
  <h1>üë• Participantes Conectados</h1>
  <h2 id="contadorPessoas">0 jogadores</h2>
  <button onclick="irParaEspera()">Continuar</button>
</div>

<!-- === ESPERA === -->
<div id="waitingScreen" class="screen hidden">
  <h2>Aguarde o anfitri√£o iniciar‚Ä¶</h2>
</div>

<!-- === ADMIN === -->
<div id="adminScreen" class="screen hidden">
  <h1>Painel do Anfitri√£o</h1>
  <p id="infoAdmin"></p>
  <button onclick="iniciarPerguntaAdmin()">Iniciar Pr√≥xima Pergunta</button>
  <br><br>
  <button style="background:#d60000" onclick="resetTotal()">üîÑ Reiniciar Quiz (Reset TOTAL)</button>
</div>

<!-- === PERGUNTA === -->
<div id="quizScreen" class="screen hidden">
  <h2 id="perguntaTexto"></h2>
  <div id="opcoes"></div>
  <div class="timer">‚è≥ Tempo: <span id="tempo">15</span>s</div>
</div>

<!-- === RANKING PARCIAL === -->
<div id="rankingScreen" class="screen hidden">
  <h2>Ranking Parcial</h2>
  <p id="tempoDaPergunta"></p>

  <table>
    <thead>
      <tr>
        <th>Jogador</th>
        <th>Pontos</th>
        <th>Tempo Total (s)</th>
      </tr>
    </thead>
    <tbody id="rankingTabela"></tbody>
  </table>

  <button onclick="adminDecide()">Continuar</button>
</div>

<!-- === RESULTADO FINAL (P√ìDIO) === -->
<div id="resultadoScreen" class="screen hidden">
  <h1>üèÜ Resultado Final</h1>
  <h3 id="tituloPodio"></h3>

  <div id="podioContainer">
    <div class="podium podium-2">
      <div class="podium-pos">ü•à 2¬∫</div>
      <div class="podium-name" id="podio2Nome">---</div>
      <div class="podium-points" id="podio2Pontos"></div>
    </div>

    <div class="podium podium-1">
      <div class="podium-pos">ü•á 1¬∫</div>
      <div class="podium-name" id="podio1Nome">---</div>
      <div class="podium-points" id="podio1Pontos"></div>
    </div>

    <div class="podium podium-3">
      <div class="podium-pos">ü•â 3¬∫</div>
      <div class="podium-name" id="podio3Nome">---</div>
      <div class="podium-points" id="podio3Pontos"></div>
    </div>
  </div>
</div>


<script>

// ===================== CONFIG ======================
const SCRIPT_URL = "https://bitter-dew-fe17.henrique-teixeira.workers.dev/";

// ------------- PERGUNTAS -------------
const perguntas = [
  { pergunta: "Quem apresentou os resultados?", opcoes: ["Pedro", "Henrique", "Saulo", "Bruno"], correta: 1 },
  { pergunta: "Qual foi o tema principal?", opcoes: ["Backlog", "Qualidade", "Rota", "Redelivery"], correta: 2 },
  { pergunta: "Qual HUB evoluiu mais?", opcoes: ["LMG-05", "LMG-62", "Barreiro", "Manaus"], correta: 0 }
];

// ------------- VARI√ÅVEIS -------------
let nomeAtual = "";
let isAdmin = false;
let listaJogadores = JSON.parse(localStorage.getItem("quizPlayers") || "[]");
let estadoServidor = {};
let indexPergunta = 0;
let ultimaPerguntaVista = 0;
let tempo = 15;
let timer;
let tempoInicioPergunta = 0;

// ------------- AUXILIARES -------------
function show(id){ document.getElementById(id).classList.remove("hidden"); }
function hide(id){ document.getElementById(id).classList.add("hidden"); }

async function getEstado(){ return (await fetch(SCRIPT_URL)).json(); }

async function postEstado(obj){
  await fetch(SCRIPT_URL, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(obj)
  });
}

// ------------- FLUXO: QR ‚Üí CADASTRO -------------
function acessarComQR(){
  hide("qrScreen");
  show("cadastroScreen");
}

// ------------- CADASTRAR JOGADOR -------------
async function entrar(){
  nomeAtual = document.getElementById("nomeJogador").value.trim();
  if (nomeAtual === "") return alert("Digite o nome!");

  isAdmin = (nomeAtual.toLowerCase() === "henriquectx");

  let registrado = localStorage.getItem("quizRegistrado") === "1";
  let estado = await getEstado();
  let total = parseInt(estado.total_jogadores);

  if (!registrado){
    total++;
    await postEstado({ total_jogadores: total });
    localStorage.setItem("quizRegistrado","1");
  }

  document.getElementById("contadorPessoas").innerText = total + " jogadores";

  hide("cadastroScreen");
  show("posCadastroScreen");
}

// ------------- SALA ‚Üí ESPERA/ADMIN -------------
function irParaEspera(){
  hide("posCadastroScreen");
  isAdmin ? show("adminScreen") : show("waitingScreen");
}

// ------------- ADMIN INICIA PERGUNTA -------------
async function iniciarPerguntaAdmin(){
  let estado = await getEstado();
  let prox = parseInt(estado.pergunta_atual) + 1;

  if (prox > perguntas.length){
    await postEstado({ pergunta_atual: 0, status: "finalizado" });
    finalizarGeral();
    return;
  }

  indexPergunta = prox - 1;
  ultimaPerguntaVista = prox;

  await postEstado({ pergunta_atual: prox, status: "respondendo" });
  exibirPerguntaAtual();
}

// ------------- MOSTRAR PERGUNTA -------------
function exibirPerguntaAtual(){
  hide("waitingScreen");
  hide("adminScreen");
  hide("rankingScreen");
  show("quizScreen");

  const q = perguntas[indexPergunta];
  document.getElementById("perguntaTexto").innerText = q.pergunta;

  let html = "";
  q.opcoes.forEach((opc,i)=>{
    html += `<div class='opcao' onclick='responder(${i})'>${opc}</div>`;
  });
  document.getElementById("opcoes").innerHTML = html;

  tempo = 15;
  document.getElementById("tempo").innerText = tempo;

  tempoInicioPergunta = Date.now();
  clearInterval(timer);

  timer = setInterval(()=>{
    tempo--;
    document.getElementById("tempo").innerText = tempo;

    if (tempo <= 0){
      clearInterval(timer);
      registrarTempo(-1);
    }
  },1000);
}

// ------------- RESPONDER -------------
function responder(opcao){
  clearInterval(timer);
  const q = perguntas[indexPergunta];
  registrarTempo(opcao === q.correta);
}

function registrarTempo(acertou){
  let tempoGasto = (Date.now()-tempoInicioPergunta)/1000;

  let p = listaJogadores.find(x=>x.nome===nomeAtual);
  if (!p){
    p = { nome:nomeAtual, pontos:0, tempoTotal:0 };
    listaJogadores.push(p);
  }

  if (acertou===true) p.pontos++;
  p.tempoTotal += tempoGasto;

  localStorage.setItem("quizPlayers", JSON.stringify(listaJogadores));

  mostrarRanking(tempoGasto);
}

// ------------- RANKING PARCIAL -------------
function mostrarRanking(tempoGasto){

  hide("quizScreen");
  show("rankingScreen");

  document.getElementById("tempoDaPergunta").innerText =
    `Voc√™ gastou: ${tempoGasto.toFixed(2)} segundos`;

  listaJogadores.sort((a,b)=>{
    if (b.pontos !== a.pontos) return b.pontos - a.pontos;
    return a.tempoTotal - b.tempoTotal;
  });

  let html = "";
  listaJogadores.forEach(p=>{
    html+=`<tr><td>${p.nome}</td><td>${p.pontos}</td><td>${p.tempoTotal.toFixed(2)}</td></tr>`;
  });

  document.getElementById("rankingTabela").innerHTML = html;
}

// ------------- ADMIN ‚Üí PR√ìXIMA -------------
function adminDecide(){
  hide("rankingScreen");
  isAdmin ? show("adminScreen") : show("waitingScreen");
}

// ------------- FINAL (P√ìDIO) -------------
function finalizarGeral(){
  hide("rankingScreen");
  hide("quizScreen");
  hide("waitingScreen");
  hide("adminScreen");
  show("resultadoScreen");

  // ordena do melhor pro pior
  listaJogadores.sort((a,b)=>{
    if (b.pontos !== a.pontos) return b.pontos - a.pontos;
    return a.tempoTotal - b.tempoTotal;
  });

  const top1 = listaJogadores[0];
  const top2 = listaJogadores[1];
  const top3 = listaJogadores[2];

  const titulo = document.getElementById("tituloPodio");
  if (listaJogadores.length === 0) {
    titulo.innerText = "Nenhum participante üòÖ";
  } else if (listaJogadores.length === 1) {
    titulo.innerText = `Campe√£o: ${top1.nome}`;
  } else {
    titulo.innerText = "Top 3 da Reuni√£o";
  }

  function fillPodio(pos, player){
    const nomeEl   = document.getElementById(`podio${pos}Nome`);
    const pontosEl = document.getElementById(`podio${pos}Pontos`);

    if (player){
      nomeEl.innerText = player.nome;
      pontosEl.innerText = `${player.pontos} pts ‚Ä¢ ${player.tempoTotal.toFixed(2)} s`;
    } else {
      nomeEl.innerText = "-";
      pontosEl.innerText = "";
    }
  }

  fillPodio(1, top1);
  fillPodio(2, top2);
  fillPodio(3, top3);
}

// ------------- RESET TOTAL (ADMIN) -------------
async function resetTotal(){
  if (!isAdmin) return;
  if (!confirm("Deseja ZERAR tudo?")) return;

  await postEstado({
    pergunta_atual: 0,
    total_jogadores: 0,
    status: "esperando"
  });

  localStorage.removeItem("quizPlayers");
  localStorage.removeItem("quizRegistrado");
  nomeAtual = "";

  alert("Quiz resetado!");

  hide("adminScreen");
  show("cadastroScreen");
}

// ------------- POLLING + CORRE√á√ÉO DO BUG -------------
async function buscarEstadoServidor(){
  try{
    let data = await getEstado();
    estadoServidor = data;

    // administra painel
    if (isAdmin){
      document.getElementById("infoAdmin").innerText =
        `Pergunta atual: ${data.pergunta_atual} / ${perguntas.length}`;
    }

    let numPerg = parseInt(data.pergunta_atual);

    // JOGADOR SINCRONIZA
    if (!isAdmin){

      // sincroniza perguntas
      if (numPerg > 0 && numPerg !== ultimaPerguntaVista){
        ultimaPerguntaVista = numPerg;
        indexPergunta = numPerg - 1;
        exibirPerguntaAtual();
      }

      // reset real ‚Üí s√≥ se jogador ainda n√£o se registrou
      if (data.status === "esperando" && localStorage.getItem("quizRegistrado") !== "1"){
        show("cadastroScreen");
      }

      // finaliza√ß√£o vinda do servidor
      if (numPerg === 0 && data.status === "finalizado"){
        finalizarGeral();
      }
    }

    // ADMIN NUNCA volta ao cadastro sozinho
    if (isAdmin && data.status === "esperando"){
      hide("cadastroScreen");
      hide("waitingScreen");
      // s√≥ mostra adminScreen se j√° passou da tela de contagem
      if (!document.getElementById("posCadastroScreen").classList.contains("hidden")) return;
      show("adminScreen");
    }

  }catch(e){
    // se der erro silencioso, n√£o quebra a tela
  }
}

setInterval(buscarEstadoServidor,1500);

</script>

</body>
</html>
