<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz da Reuni√£o</title>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f4f9;
      text-align: center;
    }
    .hidden { display: none; }
    .screen { padding: 40px; }

    input {
      padding: 10px;
      width: 260px;
      border-radius: 6px;
      border: 1px solid #aaa;
      font-size: 16px;
    }
    button {
      padding: 12px 20px;
      background: #FF5722;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      color: #fff;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover { opacity: .9; }

    .opcao {
      padding: 12px;
      margin: 10px auto;
      background: #fff;
      border: 2px solid #FF5722;
      width: 80%;
      border-radius: 8px;
      cursor: pointer;
    }

    .timer {
      margin-top: 20px;
      font-weight: bold;
      font-size: 20px;
    }

    table {
      margin: 20px auto;
      width: 90%;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
    }
    th {
      background: #FF5722;
      color: white;
    }

    #podioContainer {
      margin-top: 30px;
      display: flex;
      justify-content: center;
      gap: 20px;
    }
    .podium {
      width: 120px;
      border-radius: 12px 12px 0 0;
      background: #FF9800;
      color: #fff;
      padding: 10px 5px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      opacity: 0;
      transform: translateY(40px);
      animation: subir 0.8s ease-out forwards;
    }
    .podium-1 {
      height: 220px;
      background: #FFC107;
      animation-delay: .2s;
    }
    .podium-2 {
      height: 170px;
      background: #FF9800;
      animation-delay: 0s;
    }
    .podium-3 {
      height: 150px;
      background: #FFB74D;
      animation-delay: .4s;
    }
    .podium-pos {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 8px;
    }
    .podium-name {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 6px;
    }
    .podium-points {
      font-size: 12px;
      opacity: .9;
    }
    @keyframes subir {
      from { opacity: 0; transform: translateY(40px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .playerItem {
      margin: 10px auto;
      padding: 10px;
      width: 300px;
      box-shadow: 0 0 6px rgba(0,0,0,0.15);
      border-radius: 8px;
      background: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
  </style>
</head>
<body>

  <!-- TELA QR CODE -->
  <div id="qrScreen" class="screen">
    <h1>üîí Acesso Restrito</h1>
    <p>Escaneie o QR Code para participar</p>
    <img src="SEU_QRCODE.png" width="200" alt="QR Code para entrar">
    <button onclick="acessarComQR()">J√° escaneei</button>
  </div>

  <!-- TELA CADASTRO -->
  <div id="cadastroScreen" class="screen hidden">
    <h2>Digite seu nome para entrar</h2>
    <input id="nomeJogador" placeholder="Seu nome">
    <button onclick="entrar()">Entrar</button>
  </div>

  <!-- TELA LOBBY -->
  <div id="posCadastroScreen" class="screen hidden">
    <h1>üë• Participantes Conectados</h1>
    <h2 id="contadorPessoas">0 jogadores</h2>
    <button onclick="irParaEspera()">Continuar</button>
  </div>

  <!-- TELA ESPERA JOGADOR -->
  <div id="waitingScreen" class="screen hidden">
    <h2>Aguarde o anfitri√£o iniciar‚Ä¶</h2>
  </div>

  <!-- TELA ADMIN -->
  <div id="adminScreen" class="screen hidden">
    <h1>Painel do Anfitri√£o</h1>
    <p id="infoAdmin"></p>
    <button onclick="iniciarPerguntaAdmin()">‚ñ∂ Iniciar Pr√≥xima Pergunta</button>
    <button onclick="abrirGerenciarJogadores()">üë• Participantes Conectados</button>
    <br><br>
    <button style="background:#d60000" onclick="resetTotal()">üóëÔ∏è RESET TOTAL (LIMPAR TUDO)</button>
  </div>

  <!-- TELA GERENCIAR JOGADORES -->
  <div id="gerenciarJogadoresScreen" class="screen hidden">
    <h1>üë• Gerenciar Jogadores</h1>
    <div id="listaJogadoresAdmin"></div>
    <button onclick="voltarAdmin()">‚¨Ö Voltar</button>
  </div>

  <!-- TELA PERGUNTA -->
  <div id="quizScreen" class="screen hidden">
    <h2 id="perguntaTexto"></h2>
    <div id="opcoes"></div>
    <div class="timer">‚è≥ Tempo: <span id="tempo">15</span>s</div>
  </div>

  <!-- TELA RANKING PARCIAL -->
  <div id="rankingScreen" class="screen hidden">
    <h2>Ranking Parcial</h2>
    <p id="tempoDaPergunta"></p>
    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Pontos</th>
          <th>Tempo</th>
        </tr>
      </thead>
      <tbody id="rankingTabela"></tbody>
    </table>
    <button onclick="adminDecide()">Continuar</button>
  </div>

  <!-- TELA FINAL -->
  <div id="resultadoScreen" class="screen hidden">
    <h1>üèÜ Resultado Final</h1>
    <div id="podioContainer">
      <div class="podium podium-2">
        <div class="podium-pos">ü•à</div>
        <div class="podium-name" id="podio2Nome">---</div>
        <div class="podium-points" id="podio2Pontos"></div>
      </div>
      <div class="podium podium-1">
        <div class="podium-pos">ü•á</div>
        <div class="podium-name" id="podio1Nome">---</div>
        <div class="podium-points" id="podio1Pontos"></div>
      </div>
      <div class="podium podium-3">
        <div class="podium-pos">ü•â</div>
        <div class="podium-name" id="podio3Nome">---</div>
        <div class="podium-points" id="podio3Pontos"></div>
      </div>
    </div>

    <div id="rankingAdmin" class="hidden">
      <h2>Ranking Completo</h2>
      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th>Pontos</th>
            <th>Tempo</th>
          </tr>
        </thead>
        <tbody id="rankingAdminTabela"></tbody>
      </table>
    </div>
  </div>

  <script>
    // ===================== CONFIG ======================
    const SCRIPT_URL = "https://bitter-dew-fe17.henrique-teixeira.workers.dev/";

    const perguntas = [
      { pergunta: "Qual √© o melhor HUB da Regional MG?", opcoes: ["Uberaba", "Ub√°", "Contagem 1", "Barreiro"], correta: 0 },
      { pergunta: "Qual √© o maior HUB em Volume?",      opcoes: ["Barreiro", "Contagem 1", "Contagem 2", "Vespasiano"], correta: 1 },
      { pergunta: "Quantos HUBS tem MG?",                opcoes: ["22", "24", "26", "28"], correta: 0 },
      { pergunta: "Quantos HUBS tem CO/N?",              opcoes: ["25", "17", "21", "22"], correta: 1 },
      { pergunta: "Quantos Monitores ?",                 opcoes: ["22", "20", "25", "26"], correta: 0 }
    ];

    let nomeAtual = "";
    let isAdmin = false;
    let pontos = 0;
    let tempoTotal = 0;

    let indexPergunta = 0;
    let ultimaPerguntaVista = 0;
    let tempo = 15;
    let timer = null;
    let tempoInicioPergunta = 0;
    let jogoFinalizado = false;

    // ===================== HELPERS ======================
    function show(id) {
      document.getElementById(id).classList.remove("hidden");
    }

    function hide(id) {
      document.getElementById(id).classList.add("hidden");
    }

    async function getEstado() {
      const resp = await fetch(SCRIPT_URL);
      return resp.json();
    }

    async function postEstado(obj) {
      await fetch(SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(obj)
      });
    }

    // ===================== FLUXO INICIAL ======================
    function acessarComQR() {
      hide("qrScreen");
      show("cadastroScreen");

      const nomeSalvo = localStorage.getItem("quizNome");
      if (nomeSalvo) {
        const input = document.getElementById("nomeJogador");
        if (input) input.value = nomeSalvo;
      }
    }

    async function entrar() {
      const input = document.getElementById("nomeJogador");
      nomeAtual = (input.value || "").trim();

      if (!nomeAtual) {
        alert("Digite o nome!");
        return;
      }

      isAdmin = (nomeAtual.toLowerCase() === "henriquectx");
      pontos = 0;
      tempoTotal = 0;
      jogoFinalizado = false;

      localStorage.setItem("quizNome", nomeAtual);

      try {
        await postEstado({ addPlayer: nomeAtual });
      } catch (e) {
        console.error("Erro ao adicionar jogador:", e);
      }

      hide("cadastroScreen");
      show("posCadastroScreen");
    }

    function irParaEspera() {
      hide("posCadastroScreen");
      if (isAdmin) {
        show("adminScreen");
      } else {
        show("waitingScreen");
      }
    }

    // ===================== ADMIN FUNCTIONS ======================
    async function resetTotal() {
      if (!isAdmin) return;
      const ok = confirm("TEM CERTEZA que deseja RESETAR TUDO?\nIsso apagar√° jogadores, ranking, hist√≥rico e estado!");
      if (!ok) return;

      try {
        await postEstado({ resetAll: true });
      } catch (e) {
        console.error("Erro ao resetar:", e);
      }

      pontos = 0;
      tempoTotal = 0;
      indexPergunta = 0;
      ultimaPerguntaVista = 0;
      jogoFinalizado = false;
      nomeAtual = "";

      localStorage.removeItem("quizNome");

      alert("Sistema totalmente resetado!");

      hide("resultadoScreen");
      hide("adminScreen");
      hide("quizScreen");
      hide("rankingScreen");
      hide("waitingScreen");
      show("cadastroScreen");
    }

    async function iniciarPerguntaAdmin() {
      try {
        const est = await getEstado();
        const atual = parseInt(est.pergunta_atual ?? 0, 10) || 0;
        const prox = atual + 1;

        if (prox > perguntas.length) {
          await postEstado({ pergunta_atual: 0, status: "finalizado" });
          finalizarGeral();
          return;
        }

        indexPergunta = prox - 1;
        ultimaPerguntaVista = prox;

        await postEstado({ pergunta_atual: prox, status: "respondendo" });
        exibirPerguntaAtual();
      } catch (e) {
        console.error("Erro ao iniciar pergunta:", e);
      }
    }

    async function abrirGerenciarJogadores() {
      hide("adminScreen");
      show("gerenciarJogadoresScreen");

      try {
        const est = await getEstado();
        const players = est.players || [];

        let html = "";
        players.forEach((nome) => {
          html += `
            <div class="playerItem">
              <span>${nome}</span>
              <button style="background:#d60000" onclick="removerJogador('${nome}')">Remover</button>
            </div>`;
        });
        document.getElementById("listaJogadoresAdmin").innerHTML = html;
      } catch (e) {
        console.error("Erro ao carregar jogadores:", e);
        document.getElementById("listaJogadoresAdmin").innerHTML =
          "<p>Erro ao carregar jogadores.</p>";
      }
    }

    async function removerJogador(nome) {
      const ok = confirm(`Remover ${nome}?`);
      if (!ok) return;

      try {
        await postEstado({ removePlayer: nome });
        await abrirGerenciarJogadores();
      } catch (e) {
        console.error("Erro ao remover jogador:", e);
      }
    }

    function voltarAdmin() {
      hide("gerenciarJogadoresScreen");
      show("adminScreen");
    }

    // ===================== QUIZ ======================
    function exibirPerguntaAtual() {
      hide("waitingScreen");
      hide("adminScreen");
      hide("rankingScreen");
      show("quizScreen");

      const q = perguntas[indexPergunta];
      document.getElementById("perguntaTexto").innerText = q.pergunta;

      let html = "";
      if (!isAdmin) {
        q.opcoes.forEach((opc, i) => {
          html += `<div class="opcao" onclick="responder(${i})">${opc}</div>`;
        });
      } else {
        html = "<p>Voc√™ √© admin. Apenas observando o tempo.</p>";
      }
      document.getElementById("opcoes").innerHTML = html;

      tempo = 15;
      document.getElementById("tempo").innerText = tempo;
      tempoInicioPergunta = Date.now();

      clearInterval(timer);
      timer = setInterval(() => {
        tempo--;
        if (tempo < 0) tempo = 0;
        document.getElementById("tempo").innerText = tempo;

        if (tempo <= 0) {
          clearInterval(timer);
          if (!isAdmin) {
            registrarResposta(false);
          }
        }
      }, 1000);
    }

    function responder(opcao) {
      if (isAdmin) return;
      clearInterval(timer);

      const acertou = (opcao === perguntas[indexPergunta].correta);
      registrarResposta(acertou);
    }

    async function registrarResposta(acertou) {
      const tempoGasto = (Date.now() - tempoInicioPergunta) / 1000;

      if (acertou === true) {
        pontos++;
      }
      tempoTotal += tempoGasto;

      try {
        await postEstado({
          addRanking: {
            nome: nomeAtual,
            pontos,
            tempoTotal
          }
        });
      } catch (e) {
        console.error("Erro ao enviar ranking:", e);
      }

      await mostrarRanking(tempoGasto);
    }

    async function mostrarRanking(tempoGasto) {
      hide("quizScreen");
      show("rankingScreen");

      document.getElementById("tempoDaPergunta").innerText =
        `Voc√™ gastou: ${tempoGasto.toFixed(2)}s`;

      try {
        const est = await getEstado();
        const ranking = est.ranking || [];

        let html = "";
        ranking.forEach((p) => {
          html += `
            <tr>
              <td>${p.nome}</td>
              <td>${p.pontos}</td>
              <td>${p.tempoTotal.toFixed(2)}</td>
            </tr>`;
        });

        if (!html) {
          html = `<tr><td colspan="3">Nenhum resultado ainda.</td></tr>`;
        }

        document.getElementById("rankingTabela").innerHTML = html;
      } catch (e) {
        console.error("Erro ao buscar ranking:", e);
        document.getElementById("rankingTabela").innerHTML =
          `<tr><td colspan="3">Erro ao carregar ranking.</td></tr>`;
      }
    }

    function adminDecide() {
      hide("rankingScreen");
      if (isAdmin) {
        show("adminScreen");
      } else {
        show("waitingScreen");
      }
    }

    // ===================== FINALIZA√á√ÉO ======================
    async function finalizarGeral() {
      if (jogoFinalizado) return;
      jogoFinalizado = true;

      hide("rankingScreen");
      hide("quizScreen");
      hide("adminScreen");
      hide("waitingScreen");
      show("resultadoScreen");

      try {
        // Garantir que o servidor tenha o √∫ltimo estado deste jogador
        if (nomeAtual) {
          await postEstado({
            addRanking: {
              nome: nomeAtual,
              pontos,
              tempoTotal
            }
          });
        }

        const est = await getEstado();
        const top3 = est.top3 || [];
        const rankingGeral = est.ranking || [];

        function fill(pos, data) {
          const nomeEl = document.getElementById(`podio${pos}Nome`);
          const pontosEl = document.getElementById(`podio${pos}Pontos`);

          if (data) {
            nomeEl.textContent = data.nome;
            pontosEl.textContent =
              `${data.pontos} pts ‚Ä¢ ${data.tempoTotal.toFixed(2)}s`;
          } else {
            nomeEl.textContent = "---";
            pontosEl.textContent = "";
          }
        }

        fill(1, top3[0]);
        fill(2, top3[1]);
        fill(3, top3[2]);

        if (isAdmin) {
          show("rankingAdmin");

          let html = "";
          rankingGeral.forEach((r) => {
            html += `
              <tr>
                <td>${r.nome}</td>
                <td>${r.pontos}</td>
                <td>${r.tempoTotal.toFixed(2)}</td>
              </tr>`;
          });

          if (!html) {
            html = `<tr><td colspan="3">Nenhum resultado.</td></tr>`;
          }

          document.getElementById("rankingAdminTabela").innerHTML = html;
        }
      } catch (e) {
        console.error("Erro ao finalizar:", e);
      }
    }

    // ===================== POLLING GLOBAL ======================
    async function buscarEstadoServidor() {
      try {
        const est = await getEstado();
        const perguntaAtual = parseInt(est.pergunta_atual ?? 0, 10) || 0;
        const totalJogadores = est.total_jogadores || 0;
        const status = est.status || "esperando";

        // Atualiza contador de jogadores (lobby)
        const contador = document.getElementById("contadorPessoas");
        if (contador) {
          contador.innerText =
            `${totalJogadores} jogador${totalJogadores === 1 ? "" : "es"}`;
        }

        // Info admin
        if (isAdmin) {
          const info = document.getElementById("infoAdmin");
          if (info) {
            info.innerText =
              `Pergunta atual: ${perguntaAtual}/${perguntas.length} ‚Ä¢ ` +
              `Status: ${status}`;
          }
        }

        // Jogador comum acompanha in√≠cio das perguntas e finaliza√ß√£o
        if (!isAdmin) {
          if (perguntaAtual > 0 && perguntaAtual !== ultimaPerguntaVista) {
            ultimaPerguntaVista = perguntaAtual;
            indexPergunta = perguntaAtual - 1;
            exibirPerguntaAtual();
          }

          if (status === "finalizado" && !jogoFinalizado) {
            finalizarGeral();
          }
        }
      } catch (e) {
        console.error("Erro ao buscar estado:", e);
      }
    }

    // Faz polling a cada 1.5s
    setInterval(buscarEstadoServidor, 1500);
  </script>
</body>
</html>
